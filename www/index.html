<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <script data-ionic="inject">
    (function(w){var i=w.Ionic=w.Ionic||{};i.version='3.6.1';i.angular='4.1.3';i.staticDir='build/';})(window);
  </script>
  <meta charset="UTF-8">
  <title>Ionic App</title>
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">

  <link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> 
  <meta name="theme-color" content="#4e8ef7">

  <!-- cordova.js required for cordova apps -->
  <script src="cordova.js"></script>

  <!-- un-comment this code to enable service worker
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('service worker installed'))
        .catch(err => console.error('Error', err));
    }
  </script>-->

  <link href="build/main.css" rel="stylesheet">

</head>
<body>

  <!-- Ionic's root component and where the app will load -->
  <ion-app></ion-app>

  <!-- The polyfills js is generated during the build process -->
  <script src="build/polyfills.js"></script>

  <!-- The vendor js is generated during the build process
       It contains all of the dependencies in node_modules -->
  <script src="build/vendor.js"></script>

  <!-- The main bundle js is generated during the build process -->
  <script src="build/main.js"></script>


  <script language="javascript" type="text/javascript">
		var uri = "ws://" + window.location.host + "/data";
		var jsonObject = "";
		function connect() {
				socket = new WebSocket(uri);
				socket.onopen = function(event) {
						console.log("opened connection to " + uri);
				};
				socket.onclose = function(event) {
						console.log("closed connection from " + uri);
				};
				socket.onmessage = function(event) {
					jsonObject = JSON.parse(event.data);
					updateData(jsonObject);
				};
				socket.onerror = function(event) {
						console.log("error: " + event.data);
				};
		}
		connect();
		var dpmList = document.getElementById("DPM");
		var button = document.getElementById("refresh"); 
		button.addEventListener("click", function() {
			console.log("Refreshing ...");
			socket.send("refresh");
		});

		function appendItem(list, message) {
				var item = document.createElement("li");
				item.appendChild(document.createTextNode(message));
				list.appendChild(item);
		}  
		var backgroundColor2 = [
							'rgba(255, 99, 132, 0.2)',
							'rgba(54, 162, 235, 0.2)',
							'rgba(255, 206, 86, 0.2)',
							'rgba(75, 192, 192, 0.2)',
							'rgba(153, 102, 255, 0.2)',
							'rgba(255, 159, 64, 0.2)']
		var borderColor2 = [
							'rgba(255,99,132,1)',
							'rgba(54, 162, 235, 1)',
							'rgba(255, 206, 86, 1)',
							'rgba(75, 192, 192, 1)',
							'rgba(153, 102, 255, 1)',
							'rgba(255, 159, 64, 1)']
		var backgroundColor = [
							'rgba(54, 102, 255, 0.2)',
							'rgba(54, 122, 235, 0.2)',
							'rgba(54, 142, 215, 0.2)',
							'rgba(54, 162, 195, 0.2)',
							'rgba(54, 182, 175, 0.2)',
							'rgba(54, 202, 155, 0.2)',
							'rgba(54, 222, 135, 0.2)',
							'rgba(54, 242, 115, 0.2)']
		var borderColor = [
							'rgba(54, 102, 255, 1)',
							'rgba(54, 122, 235, 1)',
							'rgba(54, 142, 215, 1)',
							'rgba(54, 162, 195, 1)',
							'rgba(54, 222, 135, 1)',
							'rgba(54, 242, 115, 1)']

		function updateData(data) {
			updateDPM(data);
			var dataset = generateDataset(data);

			var canvas = document.getElementById("barCanvas");
			var ctx = canvas.getContext('2d');

			var myChart = new Chart(ctx, {
					type: 'bar',
					data: {
						labels: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
						datasets: dataset
				},
					options: {
						maintainAspectRatio: false,
							scales: {
									yAxes: [{
											ticks: {
													beginAtZero:false
											}
									}]
							}
					}
			});
		} 
		function generateDataset(data){
			var dataset = [];
			var i = 0;
			for (var key in data) {
				if (key.startsWith("fpyLine")){
					dataset.push({label: key,
								data: [data[key].Sunday,data[key].Monday,data[key].Tuesday,data[key].Wednesday,data[key].Thursday,data[key].Friday],
								backgroundColor: backgroundColor[i],
								borderColor: borderColor[i],
								borderWidth: 1});
					i++
				}
			}
			return dataset;
		}
		function updateDPM(data){
			while (dpmList.firstChild) {
				dpmList.removeChild(dpmList.firstChild);
			}
			for (var key in data) {
				if (key.startsWith("dpmLine")){
					appendItem(dpmList, key + ": "+ data[key]);
				}
			}
		}
</script>

</body>
</html>
